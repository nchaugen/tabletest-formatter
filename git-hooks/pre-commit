#!/bin/bash
# Pre-commit hook: formatting + build with unit tests

set -e

# Colours for output
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Colour

echo "Running pre-commit checks..."

# 1. Format Java code with Spotless
echo ""
echo "Formatting Java code with Spotless..."

# Check if any Java files are staged
if git diff --cached --name-only --diff-filter=ACM | grep -q '\.java$'; then
    # Format Maven modules
    if ! mvn spotless:apply -q; then
        echo -e "${RED}✗ Maven Spotless formatting failed${NC}"
        exit 1
    fi

    # Re-stage formatted files
    git diff --cached --name-only --diff-filter=ACM | grep '\.java$' | xargs git add

    echo -e "${GREEN}✓ Code formatted${NC}"
else
    echo "No Java files staged, skipping formatting"
fi

# 2. Build and run tests (also adds copyright headers during package phase)
echo ""
echo "Building and running tests..."
if ! mvn clean install -q; then
    echo -e "${RED}✗ Build or tests failed${NC}"
    echo "Fix the errors before committing"
    exit 1
fi
echo -e "${GREEN}✓ Build and tests successful${NC}"

# 3. Re-stage any files modified by the build (e.g., copyright headers added)
echo ""
MODIFIED_STAGED=$(git diff --name-only --diff-filter=M | grep '\.java$' || true)
if [ -n "$MODIFIED_STAGED" ]; then
    echo "Re-staging files modified by build (copyright headers)..."
    echo "$MODIFIED_STAGED" | xargs git add
    echo -e "${GREEN}✓ Files re-staged${NC}"
fi

echo -e "${GREEN}✓ Pre-commit checks passed${NC}"
exit 0
